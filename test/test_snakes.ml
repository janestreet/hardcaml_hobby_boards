open Core
open Hardcaml
open Hardcaml_waveterm
open Signal

let%expect_test "" =
  let scope = Scope.create () in
  let limit = input "rep" 2 in
  let spec = Reg_spec.create ~clock:(input "clock" 1) () in
  let set, sm =
    Hardcaml_hobby_boards_demos_nexys_a7_100t.Snakes.snake_machine scope spec limit
  in
  Always.compile [ sm ];
  let set = List.mapi set ~f:(fun idx -> output [%string "s%{idx#Int}"]) in
  let sim = Cyclesim.create (Circuit.create_exn ~name:"snake_machine" set) in
  let rep = Cyclesim.in_port sim "rep" in
  let set = Array.init 8 ~f:(fun idx -> Cyclesim.out_port sim [%string "s%{idx#Int}"]) in
  let open Bits in
  rep <--. 1;
  for _ = 0 to 35 do
    Cyclesim.cycle sim;
    for i = 0 to 7 do
      let set = !(set.(i)) in
      let c =
        if to_bool (set ==:. 0)
        then ' '
        else Char.of_int_exn (to_int_trunc (onehot_to_binary set) + Char.to_int '0')
      in
      printf "%c" c
    done;
    printf "\n"
  done;
  [%expect
    {|
    0   0
     0   0
      0   0
       0   0
       1   1
       6   6
      6   6
     6   6
    6   6
    4   4
    3   3
     3   3
      3   3
       3   3
       2   2
       6   6
      6   6
     6   6
    6   6
    5   5
    0   0
     0   0
      0   0
       0   0
       1   1
       6   6
      6   6
     6   6
    6   6
    4   4
    3   3
     3   3
      3   3
       3   3
       2   2
       6   6
    |}]
;;

let test_snakes () =
  let scope = Scope.create () in
  let spec = Reg_spec.create ~clock:(input "clock" 1) ~clear:(input "clear" 1) () in
  let switches = input "switches" 16 in
  let set_n, select_n =
    Hardcaml_hobby_boards_demos_nexys_a7_100t.Snakes.create_snakes
      ~scope
      ~spec
      ~switches
      ~scan_update:1
      ~snake_update:8
  in
  let circuit =
    Circuit.create_exn ~name:"snakes" [ output "set_n" set_n; output "select_n" select_n ]
  in
  let sim = Cyclesim.create ~config:Cyclesim.Config.trace_all circuit in
  let waves, sim = Waveform.create sim in
  let clear = Cyclesim.in_port sim "clear" in
  clear := Bits.vdd;
  Cyclesim.cycle sim;
  clear := Bits.gnd;
  Cyclesim.cycle ~n:200 sim;
  waves
;;

let%expect_test "snakes" =
  let waves = test_snakes () in
  Waveform.expect_exact waves ~wave_width:(-1) ~start_cycle:15;
  [%expect_exact
    {|
┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
│clock             ││╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥│
│                  ││╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨│
│clear             ││                                                                    │
│                  ││────────────────────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────────────────│
│switches          ││ 0000                                                               │
│                  ││────────────────────────────────────────────────────────────────────│
│                  ││─┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬│
│select_n          ││ ││││││││││││││││││││││││││││││││││││││││││││││││││││││││││││││││││││
│                  ││─┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴│
│                  ││───────────┬──┬─────┬──┬─────┬──┬─────┬──┬─────┬──┬─────┬──┬─────┬┬┬│
│set_n             ││ 00        │FE│FF   │FE│FF   │FE│FF   │FE│FF   │FE│FF   │FE│FF   ││││
│                  ││───────────┴──┴─────┴──┴─────┴──┴─────┴──┴─────┴──┴─────┴──┴─────┴┴┴│
│                  ││─┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬│
│digit_count       ││ ││││││││││││││││││││││││││││││││││││││││││││││││││││││││││││││││││││
│                  ││─┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴│
│                  ││────────────────────────────────────────────────────────────────────│
│scan_count        ││ 00000                                                              │
│                  ││────────────────────────────────────────────────────────────────────│
│                  ││──┬─────────────────────────────────────────────────────────────────│
│sets$0            ││ .│00                                                               │
│                  ││──┴─────────────────────────────────────────────────────────────────│
│                  ││──┬───────┬─────────────────────────────────────────────────────────│
│sets$1            ││ .│01     │00                                                       │
│                  ││──┴───────┴─────────────────────────────────────────────────────────│
│                  ││──────────┬───────┬─────────────────────────────────────────────────│
│sets$2            ││ 00       │01     │00                                               │
│                  ││──────────┴───────┴─────────────────────────────────────────────────│
│                  ││──────────────────┬───────┬─────────────────────────────────────────│
│sets$3            ││ 00               │01     │00                                       │
│                  ││──────────────────┴───────┴─────────────────────────────────────────│
│                  ││──────────────────────────┬───────┬─────────────────────────────────│
│sets$4            ││ 00                       │01     │00                               │
│                  ││──────────────────────────┴───────┴─────────────────────────────────│
│                  ││──────────────────────────────────┬───────┬─────────────────────────│
│sets$5            ││ 00                               │01     │00                       │
│                  ││──────────────────────────────────┴───────┴─────────────────────────│
│                  ││──────────────────────────────────────────┬───────┬─────────────────│
│sets$6            ││ 00                                       │01     │00               │
│                  ││──────────────────────────────────────────┴───────┴─────────────────│
│                  ││──────────────────────────────────────────────────┬───────┬───────┬─│
│sets$7            ││ 00                                               │01     │02     │.│
│                  ││──────────────────────────────────────────────────┴───────┴───────┴─│
│                  ││──┬───────┬─────────────────────────────────────────────────────────│
│sets1$0           ││ .│01     │00                                                       │
│                  ││──┴───────┴─────────────────────────────────────────────────────────│
│                  ││──┬───────┬───────┬─────────────────────────────────────────────────│
│sets1$1           ││ .│00     │01     │00                                               │
│                  ││──┴───────┴───────┴─────────────────────────────────────────────────│
│                  ││──┬───────────────┬───────┬─────────────────────────────────────────│
│sets1$2           ││ .│00             │01     │00                                       │
│                  ││──┴───────────────┴───────┴─────────────────────────────────────────│
│                  ││──┬───────────────────────┬───────┬─────────────────────────────────│
│sets1$3           ││ .│00                     │01     │00                               │
│                  ││──┴───────────────────────┴───────┴─────────────────────────────────│
│                  ││──┬───────────────────────────────┬───────┬─────────────────────────│
│sets1$4           ││ .│00                             │01     │00                       │
│                  ││──┴───────────────────────────────┴───────┴─────────────────────────│
│                  ││──┬───────────────────────────────────────┬───────┬─────────────────│
│sets1$5           ││ .│00                                     │01     │00               │
│                  ││──┴───────────────────────────────────────┴───────┴─────────────────│
│                  ││──┬───────────────────────────────────────────────┬───────┬─────────│
│sets1$6           ││ .│00                                             │01     │00       │
│                  ││──┴───────────────────────────────────────────────┴───────┴─────────│
│                  ││──┬───────────────────────────────────────────────────────┬───────┬─│
│sets1$7           ││ .│00                                                     │01     │.│
│                  ││──┴───────────────────────────────────────────────────────┴───────┴─│
│                  ││──┬───────┬───────┬─────────────────────────────────────────────────│
│sets2$0           ││ .│FF     │01     │00                                               │
│                  ││──┴───────┴───────┴─────────────────────────────────────────────────│
│                  ││──┬───────┬───────┬───────┬─────────────────────────────────────────│
│sets2$1           ││ .│FF     │00     │01     │00                                       │
│                  ││──┴───────┴───────┴───────┴─────────────────────────────────────────│
│                  ││──┬───────┬───────────────┬───────┬─────────────────────────────────│
│sets2$2           ││ .│FF     │00             │01     │00                               │
│                  ││──┴───────┴───────────────┴───────┴─────────────────────────────────│
│                  ││──┬───────┬───────────────────────┬───────┬─────────────────────────│
│sets2$3           ││ .│FF     │00                     │01     │00                       │
│                  ││──┴───────┴───────────────────────┴───────┴─────────────────────────│
│                  ││──┬───────┬───────────────────────────────┬───────┬─────────────────│
│sets2$4           ││ .│FF     │00                             │01     │00               │
│                  ││──┴───────┴───────────────────────────────┴───────┴─────────────────│
│                  ││──┬───────┬───────────────────────────────────────┬───────┬─────────│
│sets2$5           ││ .│FF     │00                                     │01     │00       │
│                  ││──┴───────┴───────────────────────────────────────┴───────┴─────────│
│                  ││──┬───────┬───────────────────────────────────────────────┬───────┬─│
│sets2$6           ││ .│FF     │00                                             │01     │.│
│                  ││──┴───────┴───────────────────────────────────────────────┴───────┴─│
│                  ││──┬───────┬───────────────────────────────────────────────────────┬─│
│sets2$7           ││ .│FF     │00                                                     │.│
│                  ││──┴───────┴───────────────────────────────────────────────────────┴─│
│                  ││──────────────────────────────────────────────────┬───────┬─────────│
│snake_machine     ││ Right_top                                        │Down_t.│Left_mid1│
│                  ││──────────────────────────────────────────────────┴───────┴─────────│
│                  ││─┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬┬│
│snake_update_count││ ││││││││││││││││││││││││││││││││││││││││││││││││││││││││││││││││││││
│                  ││─┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴┴│
└──────────────────┘└────────────────────────────────────────────────────────────────────┘
6af3333d136ee8a333795b2413c819fd
|}]
;;
