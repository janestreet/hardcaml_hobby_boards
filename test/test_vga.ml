open Core
open Hardcaml
open Hardcaml_waveterm

let test_video_timing cycles =
  let f scope (clocking : _ Clocking.t) =
    let spec = Clocking.to_spec clocking in
    Hardcaml_hobby_boards_demos_nexys_a7_100t.Vga.vga_demo
      scope
      spec
      Hardcaml_hobby_boards.Vga.Spec.testing
  in
  let module Sim =
    Cyclesim.With_interface (Clocking) (Hardcaml_hobby_boards.Nexys_a7_100t.Vga.O)
  in
  let scope = Scope.create ~flatten_design:true () in
  let sim = Sim.create ~config:Cyclesim.Config.trace_all (f scope) in
  let waves, sim = Waveform.create sim in
  let inputs = Cyclesim.inputs sim in
  inputs.clear := Bits.vdd;
  Cyclesim.cycle sim;
  inputs.clear := Bits.gnd;
  Cyclesim.cycle ~n:cycles sim;
  waves
;;

let%expect_test "timing" =
  let waves = test_video_timing 200 in
  Waveform.expect_exact waves ~wave_width:(-2) ~start_cycle:24;
  [%expect_exact
    {|
┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
│clock             ││╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥│
│                  ││╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨│
│clear             ││                                                                    │
│                  ││────────────────────────────────────────────────────────────────────│
│enable            ││╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ ╥ │
│                  ││╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─╨─│
│                  ││────────────────────────────────────────────────────────────────────│
│vga_b             ││ 0                                                                  │
│                  ││────────────────────────────────────────────────────────────────────│
│                  ││────────────────────────────────────────────────────────────────────│
│vga_g             ││ 0                                                                  │
│                  ││────────────────────────────────────────────────────────────────────│
│vga_hs            ││─────╥   ╥─────────────╥   ╥─────────────╥   ╥─────────────╥   ╥────│
│                  ││     ╨───╨             ╨───╨             ╨───╨             ╨───╨    │
│                  ││───────────────────────────────────────────────╥───────╥─────────╥──│
│vga_r             ││ 0                                             ║ F     ║ 0       ║ F│
│                  ││───────────────────────────────────────────────╨───────╨─────────╨──│
│vga_vs            ││     ╥──────────────────────────────────────────────────────────────│
│                  ││─────╨                                                              │
│gnd               ││                                                                    │
│                  ││────────────────────────────────────────────────────────────────────│
│                  ││─┬─┬─┬─┬─┬───┬─┬─┬─┬─┬─┬─┬─┬───┬─┬─┬─┬─┬─┬─┬─┬───┬─┬─┬─┬─┬─┬─┬─┬───┬│
│hscan$counter     ││ │0│1│0│1│0  │1│2│3│0│1│0│1│0  │1│2│3│0│1│0│1│0  │1│2│3│0│1│0│1│0  ││
│                  ││─┴─┴─┴─┴─┴───┴─┴─┴─┴─┴─┴─┴─┴───┴─┴─┴─┴─┴─┴─┴─┴───┴─┴─┴─┴─┴─┴─┴─┴───┴│
│                  ││─┬───┬───┬─┬───────┬───┬───┬─┬───────┬───┬───┬─┬───────┬───┬───┬─┬──│
│hscan$sm          ││ │Fr.│Sy.│.│Active │Fr.│Sy.│.│Active │Fr.│Sy.│.│Active │Fr.│Sy.│.│A.│
│                  ││─┴───┴───┴─┴───────┴───┴───┴─┴───────┴───┴───┴─┴───────┴───┴───┴─┴──│
│vdd               ││────────────────────────────────────────────────────────────────────│
│                  ││                                                                    │
│                  ││───────────────────────┬─────────────────┬─────────────────┬────────│
│vscan$counter     ││ 0                     │1                │0                │1       │
│                  ││───────────────────────┴─────────────────┴─────────────────┴────────│
│                  ││─────┬───────────────────────────────────┬──────────────────────────│
│vscan$sm          ││ Sync│Back_porch                         │Active                    │
│                  ││─────┴───────────────────────────────────┴──────────────────────────│
└──────────────────┘└────────────────────────────────────────────────────────────────────┘
1853ebc2ab6d3a3f7a10a2770cb5dcec
|}]
;;
